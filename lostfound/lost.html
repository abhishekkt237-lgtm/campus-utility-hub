<!DOCTYPE html>
<html>
<head>
  <title>Report Lost Item</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; font-family: Roboto; }
    body {
      background: linear-gradient(135deg,#efe6c2,#fbf8f6,#efe6c2);
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      flex-direction: column;
    }
    .box {
      background:#e9f4d1;
      padding:30px;
      width:700px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    h2 { text-align:center; margin:0 0 10px 0;
    font-size: 30px;
  font-weight: bold; }
    label { font-weight:600; margin-top:10px; display:block; }
    input, textarea {
      width:100%;
      padding:10px;
      margin-top:5px;
      border-radius:6px;
      border:1px solid #aaa;
    }
    textarea { resize:none; height:90px; }
    button {
      width:100%;
      padding:12px;
      margin-top:20px;
      background:#543002;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .my-btn {
      background:#333;
      margin-bottom:15px;
    }
  </style>
</head>

<body>

<div class="box">
  <h2>Report Lost Item</h2>

  <form id="form">
    <label>Item Name</label>
    <input id="itemName" required>

    <label>Last Seen Location</label>
    <input id="lastSeen" required>

    <label>Item Image (Optional)</label>
    <input id="image" type="file" accept="image/*">

    <label>Description</label>
    <textarea id="description" required></textarea>

    <button>Submit Lost Item</button>
    <button id="myLostBtn" class="my-btn">
  My Lost Items
</button>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAVGVP0c6e9KMdp2RmqOeGGVxr8kFsXZ7M",
    authDomain: "campus-utility-hub-iitism.firebaseapp.com",
    projectId: "campus-utility-hub-iitism"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const form = document.getElementById("form");
  const itemName = document.getElementById("itemName");
  const lastSeen = document.getElementById("lastSeen");
  const imageInput = document.getElementById("image");
  const description = document.getElementById("description");

  let currentUser = null;

  // ✅ AUTH
  onAuthStateChanged(auth, (user) => {
    if (user) currentUser = user;
    else alert("Please login first");
  });

  // ✅ CLOUDINARY (OPTIONAL IMAGE)
  async function uploadImage(file) {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", "noticeboard_upload");

    const res = await fetch(
      "https://api.cloudinary.com/v1_1/dfclsa1oc/auto/upload",
      { method: "POST", body: fd }
    );

    const data = await res.json();
    return data.secure_url;
  }

  // ✅ SUBMIT LOST ITEM
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentUser) return alert("Auth not ready");

    let imageURL = "";

    if (imageInput.files[0]) {
      imageURL = await uploadImage(imageInput.files[0]);
    }

    try {
      await addDoc(collection(db, "lostItems"), {
        itemName: itemName.value,
        lastSeen: lastSeen.value,
        description: description.value,
        imageURL, // may be empty
        reporterId: currentUser.uid,
        createdAt: serverTimestamp()
      });

      alert("✅ Lost item reported successfully");
      form.reset();
    } catch (err) {
      console.error(err);
      alert("❌ Upload failed");
    }
  });

  // ✅ REDIRECT
  document.getElementById("myLostBtn").onclick = () => {
    window.location.href = "mylost.html";
  };
</script>

</body>
</html>
