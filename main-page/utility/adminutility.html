<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utility Status Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background:#f5f5f5; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }
.utility-card { background:white; padding:20px; margin:15px auto; max-width:600px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
.utility-card h2 { margin-bottom:10px; }
label { display:block; margin:10px 0 5px; font-weight:bold; }
.radio-group { display:flex; gap:20px; margin-bottom:10px; }
.radio-group input { margin-right:5px; }
input[type=text], input[type=file], select { width:100%; padding:10px; border-radius:6px; border:1px solid #aaa; margin-bottom:10px; }
button { padding:12px 20px; background:#333; color:white; border:none; border-radius:6px; cursor:pointer; margin-top:5px; }
.success { color: green; margin-top:10px; }
.error { color: red; margin-top:10px; }
</style>
</head>
<body>

<h1>Utility Status Admin</h1>

<div class="utility-card">
   <div>
     <label for="hostelSelect">Select Hostel</label>
  <select id="hostelSelect">
      <option value="">-- Select Hostel --</option>
      <option value="HostelA">Amber</option>
      <option value="HostelB">Diamond</option>
      <option value="HostelC">>Jasper </option>
      <option value="HostelD">Sapphire</option>
      <option value="HostelE">Topaz</option>
      <option value="HostelF">Aquamarine</option>
      <option value="HostelG">Emerald</option>
      <option value="HostelH">Opal</option>
      <option value="HostelI">Rosaline and Ruby</option>
      <option value="HostelJ">International Hostel</option>
    </select>
  </div>
  <label for="blockSelect">Select Block</label>
 <select id="blockSelect">
      <option value="">-- Select Block --</option>
      <option value="Block1">Block A</option>
      <option value="Block2">Block B</option>
       <option value="Block3">Block C</option>
      <option value="Block4">Block D</option>
       <option value="Block5">Block E</option>
      <option value="Block5">Block F</option>
    </select>
  </div>
</div>

<!-- Utility template -->
<div class="utility-card" id="utilityTemplate" style="display:none;">
  <h2 class="utilityName">UTILITY</h2>
  <div class="radio-group">
    <label><input type="radio" name="status" value="true" class="statusRadio"> Running ðŸŸ¢</label>
    <label><input type="radio" name="status" value="false" class="statusRadio"> Not Running ðŸ”´</label>
  </div>
  <label>Message or PDF (if not running)</label>
  <input type="text" class="msgInput" placeholder="Enter message">
  <input type="file" class="pdfInput" accept="application/pdf">
  <button class="updateBtn">Update</button>
  <div class="result"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVGVP0c6e9KMdp2RmqOeGGVxr8kFsXZ7M",
  authDomain: "campus-utility-hub-iitism.firebaseapp.com",
  projectId: "campus-utility-hub-iitism",
  storageBucket: "campus-utility-hub-iitism.appspot.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CLOUD_NAME = "dfclsa1oc"; 
const UPLOAD_PRESET = "unsigned_pdf_upload"; 

const utilities = ["wifi","electricity","water","laundry"];
const template = document.getElementById("utilityTemplate");

const hostelSelect = document.getElementById("hostelSelect");
const blockSelect = document.getElementById("blockSelect");

// Create utility cards dynamically
const utilityCards = {};
utilities.forEach(u => {
  const clone = template.cloneNode(true);
  clone.style.display = "block";
  clone.id = u + "Card";
  clone.querySelector(".utilityName").innerText = u.charAt(0).toUpperCase() + u.slice(1);
  clone.querySelectorAll(".statusRadio").forEach(r => r.name = u + "Status");
  clone.querySelector(".updateBtn").onclick = () => updateUtility(u, clone);
  
  // Hide success message on any input change
  clone.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => clone.querySelector(".result").innerText = "");
    inp.addEventListener("change", () => clone.querySelector(".result").innerText = "");
  });
  
  document.body.appendChild(clone);
  utilityCards[u] = clone;
});

// Cloudinary upload
async function uploadPDF(file){
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);  // <-- use the constant
  formData.append("resource_type", "raw"); 
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`, {
    method:"POST", 
    body:formData
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);  // optional: catch Cloudinary errors
  return data.secure_url;
}


// Update utility
async function updateUtility(name, card) {
  const block = document.getElementById("blockSelect").value;
  const hostel = document.getElementById("hostelSelect").value;
  if (!block || !hostel) return alert("Select block and hostel first");

  const statusRadios = card.querySelectorAll(".statusRadio");
  let statusValue = null;
  statusRadios.forEach(r => { if(r.checked) statusValue = r.value; });
  if (statusValue === null) return alert("Select Running / Not Running");

  const isRunning = statusValue === "true";
  const msgEl = card.querySelector(".msgInput");
  const pdfEl = card.querySelector(".pdfInput");
  const resultEl = card.querySelector(".result");

  let message = isRunning ? "" : msgEl.value || "";
  let pdfURL = "";

  try {
    // Upload PDF if exists
    if(pdfEl.files && pdfEl.files.length > 0){
      const pdfFile = pdfEl.files[0];
      pdfURL = await uploadPDF(pdfFile); // returns Cloudinary URL
    }

    // Firestore doc ID = hostel_block
    const docRef = doc(db, "utilities", `${hostel}_${block}`);
    const docSnap = await getDoc(docRef);
    let data = docSnap.exists() ? docSnap.data() : {};

    data[name] = {
      isRunning,
      message,
      pdfURL,          // store PDF URL separately
      updatedAt: new Date().toISOString()
    };

    data.block = block; // store block info for reference
    await setDoc(docRef, data);

    resultEl.innerText = "âœ… Updated successfully";
    resultEl.className = "success";
    pdfEl.value = "";

  } catch(err) {
    console.error(err);
    resultEl.innerText = "âŒ Update failed";
    resultEl.className = "error";
  }
}


// Load existing data when block or hostel changes
async function loadData(){
  const block = blockSelect.value;
  const hostel = hostelSelect.value;
  if(!block || !hostel){
    utilities.forEach(u => {
      const c = utilityCards[u];
      c.querySelector(".msgInput").value = "";
      c.querySelectorAll(".statusRadio").forEach(r => r.checked = false);
      c.querySelector(".result").innerText = "";
    });
    return;
  }

  const blockRef = doc(db, "utilities", hostel + "_" + block);
  const docSnap = await getDoc(blockRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    utilities.forEach(u => {
      const c = utilityCards[u];
      const utilData = data[u];
      if(utilData){
        c.querySelector(".msgInput").value = utilData.message || "";
        c.querySelectorAll(".statusRadio").forEach(r => r.checked = (r.value === String(utilData.isRunning)));
      }else{
        c.querySelector(".msgInput").value = "";
        c.querySelectorAll(".statusRadio").forEach(r => r.checked = false);
      }
      c.querySelector(".result").innerText = "";
    });
  }else{
    utilities.forEach(u => {
      const c = utilityCards[u];
      c.querySelector(".msgInput").value = "";
      c.querySelectorAll(".statusRadio").forEach(r => r.checked = false);
      c.querySelector(".result").innerText = "";
    });
  }
}

hostelSelect.addEventListener("change", loadData);
blockSelect.addEventListener("change", loadData);
</script>

</body>
</html>
